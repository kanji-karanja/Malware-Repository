<?php
require "./_cred.php";
session_start();
if(isset($_GET['report-type']) && isset($_SESSION['username'])){
    if($_GET['report-type']=="statistics") {
        $sql = "SELECT * FROM `malware_engines`";
        $result = $conn->query($sql);
        $engine_count = $result->num_rows;
        $sql = "SELECT * FROM `malware`";
        $result = $conn->query($sql);
        $malware_count = $result->num_rows;
        $sql = "SELECT * FROM `malware_categories`";
        $result = $conn->query($sql);
        $category_count = $result->num_rows;
        $username = $_SESSION["username"];
        $sql = "SELECT * FROM downloads WHERE username_downloaded='$username'";
        $result = $conn->query($sql);
        $download_count = $result->num_rows;
        $id = $_SESSION["id"];
        $sql = "SELECT * FROM malware WHERE users_id_users ='$id'";
        $result = $conn->query($sql);
        $upload_count = $result->num_rows;
        echo "
        <!DOCTYPE html>
<html>
<head>
    <meta charset=\"utf-8\">
    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, shrink-to-fit=no\">
    <title>Malware Repository Report | Statistics</title>
    <link rel=\"stylesheet\" href=\"assets/bootstrap/css/bootstrap.min.css\">
    <link rel=\"stylesheet\" href=\"https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i\">
    <link rel=\"stylesheet\" href=\"https://use.fontawesome.com/releases/v5.7.1/css/all.css\">
    <link rel=\"stylesheet\" href=\"./assets/fonts/ionicons.min.css\">
    <link rel=\"manifest\" href=\"./manifest.json\"/>
    <link rel=\"stylesheet\" href=\"assets/css/Footer-Dark.css\">
    <script src=\"https://d3js.org/d3.v5.min.js\"></script>
    <link rel=\"stylesheet\" type=\"text/css\" href=\"print.css\" media=\"print\" />
    </head>
    <body><h3 class=\"text-dark\" style=\"margin: 20px 20px\">Statistics<a class=\"btn btn-primary btn-sm float-right no-print\" role=\"button\" href=\"javascript:void(0)\" onclick='print()'><i class=\"fas fa-print fa-sm text-white-50\"></i>Â Print</a></h3>
        ";
        echo "<div class=\"row\" style=\"margin: 20px 0\">
    <div class=\"col-md-6 col-xl-3 mb-4\">
    <a href=\"./all-samples.php\">
        <div class=\"card shadow border-left-primary py-2\">
            <div class=\"card-body\">
                <div class=\"row align-items-center no-gutters\">
                    <div class=\"col mr-2\">
                        <div class=\"text-uppercase text-primary font-weight-bold text-xs mb-1\"><span>Total Number of Samples</span></div>
                        <div class=\"text-dark font-weight-bold h5 mb-0\"><span>$malware_count</span></div>
                    </div>
                    <div class=\"col-auto\"><i class=\"fas fa-calendar fa-2x text-gray-300\"></i></div>
                </div>
            </div>
        </div>
    </a>
    </div>
     <div class=\"col-md-6 col-xl-3 mb-4\">
    <a href=\"./all-samples.php\">
        <div class=\"card shadow border-left-primary py-2\">
            <div class=\"card-body\">
                <div class=\"row align-items-center no-gutters\">
                    <div class=\"col mr-2\">
                        <div class=\"text-uppercase text-primary font-weight-bold text-xs mb-1\"><span>Total Categories</span></div>
                        <div class=\"text-dark font-weight-bold h5 mb-0\"><span>$category_count</span></div>
                    </div>
                    <div class=\"col-auto\"><i class=\"fas fa-book fa-2x text-gray-300\"></i></div>
                </div>
            </div>
        </div>
    </a>
    </div>
     <div class=\"col-md-6 col-xl-3 mb-4\">
    <a href=\"./all-samples.php\">
        <div class=\"card shadow border-left-primary py-2\">
            <div class=\"card-body\">
                <div class=\"row align-items-center no-gutters\">
                    <div class=\"col mr-2\">
                        <div class=\"text-uppercase text-primary font-weight-bold text-xs mb-1\"><span>Total Engines</span></div>
                        <div class=\"text-dark font-weight-bold h5 mb-0\"><span>$engine_count</span></div>
                    </div>
                    <div class=\"col-auto\"><i class=\"fas fa-calendar fa-2x text-gray-300\"></i></div>
                </div>
            </div>
        </div>
    </a>
    </div>
    <div class=\"col-md-6 col-xl-3 mb-4\">
        <div class=\"card shadow border-left-success py-2\">
            <div class=\"card-body\">
                <div class=\"row align-items-center no-gutters\">
                    <div class=\"col mr-2\">
                        <div class=\"text-uppercase text-success font-weight-bold text-xs mb-1\"><span>Your Sample Uploads</span></div>
                        <div class=\"text-dark font-weight-bold h5 mb-0\"><span>$upload_count</span></div>
                    </div>
                    <div class=\"col-auto\"><i class=\"fas fa-upload fa-2x text-gray-300\"></i></div>
                </div>
            </div>
        </div>
    </div>
    <div class=\"col-md-6 col-xl-3 mb-4\">
        <div class=\"card shadow border-left-info py-2\">
            <div class=\"card-body\">
                <div class=\"row align-items-center no-gutters\">
                    <div class=\"col mr-2\">
                        <div class=\"text-uppercase text-info font-weight-bold text-xs mb-1\"><span>Your Sample Downloads</span></div>
                        <div class=\"row no-gutters align-items-center\">
                            <div class=\"col-auto\">
                                <div class=\"text-dark font-weight-bold h5 mb-0 mr-3\"><span>$download_count</span></div>
                            </div>
                        </div>
                    </div>
                    <div class=\"col-auto\"><i class=\"fas fa-download fa-2x text-gray-300\"></i></div>
                </div>
            </div>
        </div>
    </div>
    <div class=\"col-md-6 col-xl-3 mb-4\">
        <div class=\"card shadow border-left-warning py-2\">
            <div class=\"card-body\">
                <div class=\"row align-items-center no-gutters\">
                    <div class=\"col mr-2\">
                        <div class=\"text-uppercase text-warning font-weight-bold text-xs mb-1\"><span>Pending Requests</span></div>
                        <div class=\"text-dark font-weight-bold h5 mb-0\"><span>18</span></div>
                    </div>
                    <div class=\"col-auto\"><i class=\"fas fa-comments fa-2x text-gray-300\"></i></div>
                </div>
            </div>
        </div>
    </div>
</div>

";
    }
}
?>
<div class="row">
<div class="col-md-6 col-xl-3 mb-4">
    <h4 class="text-dark" style="margin: 20px 20px">Samples you have Uploaded</h4>
    <svg width="300" height="200" id="uploaded"> </svg>
</div>
<div class="col-md-6 col-xl-3 mb-4">
<h4 class="text-dark" style="margin: 20px 20px">Samples you have downloaded</h4>
    <svg width="300" height="200" id="downloaded"> </svg>
</div>
    <div class="col-md-6 col-xl-3 mb-4">
        <h4 class="text-dark" style="margin: 20px 20px">Categories you have added</h4>
        <svg width="300" height="200" id="categories"> </svg>
    </div>
    <div class="col-md-6 col-xl-3 mb-4">
        <h4 class="text-dark" style="margin: 20px 20px">Engines you have downloaded</h4>
        <svg width="300" height="200" id="engines"> </svg>
    </div>
</div>
<script>
    //var data = [0,<?php //echo $malware_count;?>];
    const createChart = (id,data1,data2)=>{
        var data = [data1,data2];
        var svg = d3.select("#"+id),
            width = svg.attr("width"),
            height = svg.attr("height"),
            radius = Math.min(width, height) / 2,
            g = svg.append("g").attr("transform", "translate(" + width / 2 + "," + height / 2 + ")")
        var color1 =Math.floor(Math.random() * 2);
        var color2 =Math.floor(Math.random() * 2);
        let colorlist = ['#4daf4a','#377eb8','#ff7f00'];
        let colorlist2 =['#984ea3','#e41a1c','#341a1c'];

        var color = d3.scaleOrdinal([colorlist[color1],colorlist2[color2]]);

        // Generate the pie
        var pie = d3.pie();

        // Generate the arcs
        var arc = d3.arc()
            .innerRadius(0)
            .outerRadius(radius);

        //Generate groups
        var arcs = g.selectAll("arc")
            .data(pie(data))
            .enter()
            .append("g")
            .attr("class", "arc")

        //Draw arc paths
        arcs.append("path")
            .attr("fill", function(d, i) {
                return color(i);
            })
            .attr("d", arc);
    }
    createChart("uploaded",19,200);
    createChart("downloaded",99,200);
    createChart("categories",89,500);
    createChart("engines",300,2000);
</script>
