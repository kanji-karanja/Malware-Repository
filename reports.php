<script>
    //var data = [0,<?php //echo $malware_count;?>];
    const createChart = (id,data1,data2,label1,label2)=>{
        var data = [data1,data2];
        var svg = d3.select("#"+id),
            width = svg.attr("width"),
            height = svg.attr("height"),
            radius = Math.min(width, height) / 2,
            g = svg.append("g").attr("transform", "translate(" + width / 2 + "," + height / 2 + ")")
        var color1 =Math.floor(Math.random() * 6);
        var color2 =Math.floor(Math.random() * 6);
        let colorlist = ['#4daf4a','#377eb8','#ff7f00','#e0d914','#939baf','#8cf7a7'];
        let colorlist2 =['#984ea3','#e41a1c','#00a7d0','#0a2156','#ef539f','#6777ef'];
        let explain = [label1+" : "+data1 ,label2+" : " + data2];
        let explainCounter = -1;
        var label = d3.arc()
            .outerRadius(radius)
            .innerRadius(radius-100);

        var color = d3.scaleOrdinal([colorlist[color1],colorlist2[color2]]);

        // Generate the pie
        var pie = d3.pie();

        // Generate the arcs
        var arc = d3.arc()
            .outerRadius(radius)
            .innerRadius(80);

        //Generate groups
        var arcs = g.selectAll("arc")
            .data(pie(data))
            .enter()
            .append("g")
            .attr("class", "arc");

        //Draw arc paths
        arcs.append("path")
            .attr("fill", function(d, i) {
                return color(i);
            })
            .attr("d", arc);
        arcs.append("text")
            .attr("transform", function(d) {
                return "translate(" + label.centroid(d) + ")";
            })
            .text(function(){
                while(explainCounter<=explain.length){
                    explainCounter++;
                    return explain[explainCounter]}});
    };
</script>
<?php
require "./_cred.php";
session_start();
if(isset($_GET['report-type']) && isset($_SESSION['username'])){
    if($_GET['report-type']=="statistics") {
        $username = $_SESSION['username'];
        $sql = "SELECT * FROM `malware_engines`";
        $result = $conn->query($sql);
        $engine_count = $result->num_rows;
        $sql = "SELECT * FROM `malware_engines` WHERE added_by='$username'";
        $result = $conn->query($sql);
        $engine_added_count = $result->num_rows;
        $sql = "SELECT * FROM `malware_samples`";
        $result = $conn->query($sql);
        $malware_count = $result->num_rows;
        $sql = "SELECT * FROM `malware_categories`";
        $result = $conn->query($sql);
        $category_count = $result->num_rows;
        $sql = "SELECT * FROM `malware_categories` WHERE added_by='$username'";
        $result = $conn->query($sql);
        $category_added_count = $result->num_rows;
        $username = $_SESSION["username"];
        $sql = "SELECT * FROM downloads WHERE username_downloaded='$username'";
        $result = $conn->query($sql);
        $download_count = $result->num_rows;
        $id = $_SESSION["id"];
        $sql = "SELECT * FROM malware_samples WHERE user_id ='$id'";
        $result = $conn->query($sql);
        $upload_count = $result->num_rows;
        echo "
        <!DOCTYPE html>
<html>
<head>
    <meta charset=\"utf-8\">
    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, shrink-to-fit=no\">
    <title>Malware Repository Report | Statistics</title>
    <script src=\"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js\"></script>
    <link rel=\"stylesheet\" href=\"assets/bootstrap/css/bootstrap.min.css\">
    <link rel=\"stylesheet\" href=\"https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i\">
    <link rel=\"stylesheet\" href=\"https://use.fontawesome.com/releases/v5.7.1/css/all.css\">
    <link rel=\"stylesheet\" href=\"./assets/fonts/ionicons.min.css\">
    <link rel=\"manifest\" href=\"./manifest.json\"/>
    <link rel=\"stylesheet\" href=\"assets/css/Footer-Dark.css\">
    <script src=\"https://d3js.org/d3.v5.min.js\"></script>
    <link rel=\"stylesheet\" type=\"text/css\" href=\"print.css\" media=\"print\" />
    </head>
    <body><h3 class=\"text-dark\" style=\"margin: 20px 20px\">Statistics<a class=\"btn btn-primary btn-sm float-right no-print\" role=\"button\" href=\"javascript:void(0)\" onclick='print()'><i class=\"fas fa-print fa-sm text-white-50\"></i>Â Print</a></h3>
        ";
        echo "<div class=\"row\" style=\"margin: 20px 0\">
    <div class=\"col-md-6 col-xl-3 mb-4\">
    <a href=\"./all-samples.php\">
        <div class=\"card shadow border-left-primary py-2\">
            <div class=\"card-body\">
                <div class=\"row align-items-center no-gutters\">
                    <div class=\"col mr-2\">
                        <div class=\"text-uppercase text-primary font-weight-bold text-xs mb-1\"><span>Total Number of Samples</span></div>
                        <div class=\"text-dark font-weight-bold h5 mb-0\"><span>$malware_count</span></div>
                    </div>
                    <div class=\"col-auto\"><i class=\"fas fa-calendar fa-2x text-gray-300\"></i></div>
                </div>
            </div>
        </div>
    </a>
    </div>
     <div class=\"col-md-6 col-xl-3 mb-4\">
    <a href=\"./?page=loggedin\">
        <div class=\"card shadow border-left-primary py-2\">
            <div class=\"card-body\">
                <div class=\"row align-items-center no-gutters\">
                    <div class=\"col mr-2\">
                        <div class=\"text-uppercase text-primary font-weight-bold text-xs mb-1\"><span>Total Categories</span></div>
                        <div class=\"text-dark font-weight-bold h5 mb-0\"><span>$category_count</span></div>
                    </div>
                    <div class=\"col-auto\"><i class=\"fas fa-book fa-2x text-gray-300\"></i></div>
                </div>
            </div>
        </div>
    </a>
    </div>
     <div class=\"col-md-6 col-xl-3 mb-4\">
    <a href=\"./?page=loggedin\">
        <div class=\"card shadow border-left-primary py-2\">
            <div class=\"card-body\">
                <div class=\"row align-items-center no-gutters\">
                    <div class=\"col mr-2\">
                        <div class=\"text-uppercase text-primary font-weight-bold text-xs mb-1\"><span>Total Engines</span></div>
                        <div class=\"text-dark font-weight-bold h5 mb-0\"><span>$engine_count</span></div>
                    </div>
                    <div class=\"col-auto\"><i class=\"fas fa-calendar fa-2x text-gray-300\"></i></div>
                </div>
            </div>
        </div>
    </a>
    </div>
    <div class=\"col-md-6 col-xl-3 mb-4\">
    <a href=\"./?page=loggedin\">
        <div class=\"card shadow border-left-primary py-2\">
            <div class=\"card-body\">
                <div class=\"row align-items-center no-gutters\">
                    <div class=\"col mr-2\">
                        <div class=\"text-uppercase text-success font-weight-bold text-xs mb-1\"><span>Categories you have added</span></div>
                        <div class=\"text-dark font-weight-bold h5 mb-0\"><span>$category_added_count</span></div>
                    </div>
                    <div class=\"col-auto\"><i class=\"fas fa-calendar fa-2x text-gray-300\"></i></div>
                </div>
            </div>
        </div>
    </a>
    </div>
    <div class=\"col-md-6 col-xl-3 mb-4\">
    <a href=\"./?page=loggedin\">
        <div class=\"card shadow border-left-primary py-2\">
            <div class=\"card-body\">
                <div class=\"row align-items-center no-gutters\">
                    <div class=\"col mr-2\">
                        <div class=\"text-uppercase text-success font-weight-bold text-xs mb-1\"><span>Engines You have added</span></div>
                        <div class=\"text-dark font-weight-bold h5 mb-0\"><span>$engine_added_count</span></div>
                    </div>
                    <div class=\"col-auto\"><i class=\"fas fa-calendar fa-2x text-gray-300\"></i></div>
                </div>
            </div>
        </div>
    </a>
    </div>
    <div class=\"col-md-6 col-xl-3 mb-4\">
        <div class=\"card shadow border-left-success py-2\">
            <div class=\"card-body\">
                <div class=\"row align-items-center no-gutters\">
                    <div class=\"col mr-2\">
                        <div class=\"text-uppercase text-success font-weight-bold text-xs mb-1\"><span>Your Sample Uploads</span></div>
                        <div class=\"text-dark font-weight-bold h5 mb-0\"><span>$upload_count</span></div>
                    </div>
                    <div class=\"col-auto\"><i class=\"fas fa-upload fa-2x text-gray-300\"></i></div>
                </div>
            </div>
        </div>
    </div>
    <div class=\"col-md-6 col-xl-3 mb-4\">
        <div class=\"card shadow border-left-info py-2\">
            <div class=\"card-body\">
                <div class=\"row align-items-center no-gutters\">
                    <div class=\"col mr-2\">
                        <div class=\"text-uppercase text-success font-weight-bold text-xs mb-1\"><span>Your Sample Downloads</span></div>
                        <div class=\"row no-gutters align-items-center\">
                            <div class=\"col-auto\">
                                <div class=\"text-dark font-weight-bold h5 mb-0 mr-3\"><span>$download_count</span></div>
                            </div>
                        </div>
                    </div>
                    <div class=\"col-auto\"><i class=\"fas fa-download fa-2x text-gray-300\"></i></div>
                </div>
            </div>
        </div>
    </div>
</div>
";
        echo '<div class="row">
<div class="col-md-6 col-xl-3 mb-4">
    <h4 class="text-dark" style="margin: 20px 20px">Samples you have Uploaded</h4>
    <span id="uploadedAll" style="padding-left: 20px"></span>
    <svg width="300" height="200" id="uploaded"> </svg>
</div>
<div class="col-md-6 col-xl-3 mb-4">
<h4 class="text-dark" style="margin: 20px 10px">Samples you have downloaded</h4>
<span id="downloadedAll" style="padding-left: 20px"></span>
    <svg width="300" height="200" id="downloaded"> </svg>
</div>
    <div class="col-md-6 col-xl-3 mb-4" >
        <h4 class="text-dark" style="margin: 20px 20px">Categories you have added</h4>
        <span id="categoriesAll" style="padding-left: 20px"></span>
        <svg width="300" height="200" id="categories"> </svg>
    </div>
    <div class="col-md-6 col-xl-3 mb-4">
        <h4 class="text-dark" style="margin: 20px 20px">Engines you have Added</h4>
        <span id="enginesAll" style="padding-left: 20px"></span>
        <svg width="300" height="200" id="engines"> </svg>
    </div>
</div>';
}
    echo "<script>
if($malware_count>0){
    createChart(\"uploaded\",$upload_count,$malware_count-$upload_count,\"You\",\"Others\");
}
else{
    $('#uploadedAll').append('No Chart to draw');
}
if($malware_count>0){
    createChart(\"downloaded\",99,$malware_count,\"You\",\"Others\");
}
else{
    $('#downloadedAll').append('No Chart to draw');
}
if($engine_count>0){
     createChart(\"engines\",300,$engine_count,\"You\",\"Others\");
}
else{
    $('#enginesAll').append('No Chart to draw');
}
if( $category_added_count>0){
    createChart(\"categories\", $category_added_count,$category_count-$category_added_count,\"You\",\"Others\");
}
else{
    $('#categoriesAll').append('No Chart to draw');
    
}    
    </script>";
//     echo "<script>createChart(\"uploaded\",10,50,\"You\",\"Others\");
// createChart(\"downloaded\",99,200,\"You\",\"Others\");
// createChart(\"engines\",300,199,\"You\",\"Others\");
// createChart(\"categories\", 10,82,\"You\",\"Others\");
// </script>";

}
else{
    echo "
    <!DOCTYPE html>
<html>
<head>
    <meta charset=\"utf-8\">
    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, shrink-to-fit=no\">
    <title>Malware Repository Report | Statistics</title>
    <link rel=\"stylesheet\" href=\"assets/bootstrap/css/bootstrap.min.css\">
    <link rel=\"stylesheet\" href=\"https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i\">
    <link rel=\"stylesheet\" href=\"https://use.fontawesome.com/releases/v5.7.1/css/all.css\">
    <link rel=\"stylesheet\" href=\"./assets/fonts/ionicons.min.css\">
    <link rel=\"manifest\" href=\"./manifest.json\"/>
    <link rel=\"stylesheet\" href=\"assets/css/Footer-Dark.css\">
    <script src=\"https://d3js.org/d3.v5.min.js\"></script>
    <link rel=\"stylesheet\" type=\"text/css\" href=\"print.css\" media=\"print\" />
    </head>
    <body>

    <div class=\"col-md-6 col-xl-3 mb-4 text-center\" STYLE='margin: auto; left:0; bottom: 0; right: 0; top:80px;'>
    <div class='alert alert-danger'>The request could not be completed because it is invalid.&nbsp;";
    if(!isset($_SESSION['username'])){
        echo "You need to sign in first! Click <a href='./?page=signin'>here</a> to sign in. If you don't have an account, sign up <a href='./?page=signup'>here</a>";
    }
    echo"
    </div>
    </div>
</body></html>";
}
?>

