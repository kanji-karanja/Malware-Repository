<?php
session_start();
if(isset($_SESSION['username'])){
}
else{
    echo("<script>location.href = './?page=signin';</script>");
}
require './_cred.php';
$sql = "SELECT * FROM `questions` ORDER BY id DESC LIMIT 1";
$result = $conn->query($sql);
if ($result->num_rows > 0) {
    // output data of each row
    while($row = $result->fetch_assoc()) {
     $json_values = $row["json_values"];
    }
} else {
    $json_values ="'Could not fill data'";
}
?>
<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Malware Repository | Malware Test</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.1/css/all.css">
    <link rel="stylesheet" href="./assets/fonts/ionicons.min.css">
    <link rel="manifest" href="./manifest.json"/>
    <link rel="stylesheet" href="assets/css/Footer-Dark.css">
    <style>
        body{
            color: black;
        }
        .card-1 {
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            transition: all 0.3s cubic-bezier(.25,.8,.25,1);
        }

        .card-1:hover {
            box-shadow: 0 14px 28px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22);
        }

        .card-2 {
            box-shadow: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
        }

        .card-3 {
            box-shadow: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
        }

        .card-4 {
            box-shadow: 0 14px 28px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22);
        }

        .card-5 {
            box-shadow: 0 19px 38px rgba(0,0,0,0.30), 0 15px 12px rgba(0,0,0,0.22);
        }
        .navbar{
            background-color: #282D32;
        }
    </style>
</head>
<body class="bg-gradient-dark">
<nav class="navbar navbar-light text-light navbar-expand-md sticky-top card-2">
    <div class="container-fluid" style="padding: 5px"><a href="javascript:void(0)" class = "text-light" onclick="window.history.back();" style="margin-right: 20px"><i class="fas fa-arrow-left"></i></a>
        <a class="navbar-brand text-light" href="./?page=home" style="position: fixed; left: 80px;">Malware Repository</a>
         <?php require './account.manager.php';?>
         </div>
</nav>
<div>
        <div id="message"></div>
        <div class="container" style="margin-top: 35px;">
            <div class="row">
                <div class="col-md-3"></div>
                <div class="col-md-6 card card-body" id="questions-here">
                <h3>Malware Test Questions <a class="btn btn-primary btn-sm float-right" role="button" href="javascript:void(0)" onclick="fillData()"><i class="fa fa-refresh fa-sm text-white-50"></i> Fill from Existing</a> </h3>
                    <div id="question-1"><span><strong>Note:</strong>&nbsp;A weight of&nbsp;<strong>0</strong>&nbsp;suggests&nbsp;<strong class="text-success">No infection by malware</strong>&nbsp; and a weight of&nbsp;<strong>1</strong>&nbsp;suggests&nbsp;<strong class="text-danger">Malware Infection</strong></span>
                        <div id="removeFill"><button class="btn btn-primary float-right btn-sm" type="button" style="margin: 10px 0;" onclick="addQuestion()"><i class="fa fa-plus"></i></button><label style="margin: 10px 0;"><strong>Question 1<br></strong></label><input class="form-control"
                                type="text" id="q1" onfocusout="changeJson(this.id,this.value)">
                            <div class="form-row">
                                <div class="col"><label>Answer 1</label><input class="form-control" type="text" id="q1-a1" onfocusout="changeJson(this.id,this.value)"></div>
                                <div class="col"><label>Weight</label><select class="form-control" id="q1-w1" onfocusout="changeJson(this.id,this.value)"><option value="0" selected="">0</option><option value="1">1</option></select></div>
                            </div>
                            <div class="form-row">
                                <div class="col"><label>Answer 2</label><input class="form-control" type="text" id="q1-a2" onfocusout="changeJson(this.id,this.value)"></div>
                                <div class="col"><label>Weight</label><select class="form-control" id="q1-w2" onfocusout="changeJson(this.id,this.value)"><option value="0">0</option><option value="1" selected="">1</option></select></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3"></div>
            </div>
        </div>
    </div>
    <div class="container" style="margin-top:20px"><div class="row">
    <div class="col-md-3"></div>
                <div class="col-md-6 card card-body">
    <label>Output in JSON <span class="text-danger float-right" id="jsonerror"></span></label><textarea id="output" class="form-control" rows="10" spellcheck="false" onfocusout="changeOutput(this.value)"></textarea></div>
    </div>
                <div class="col-md-3"></div>
    <button class="btn btn-success" type="button" style="bottom:10px; right:10px; position: fixed; z-index: 100&quot;" onclick="checkIfEmpty()">Save Changes</button>
    <div
        class="modal fade" role="dialog" tabindex="-1" id="confirm-changes">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Confirm saving changes.</h4><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button></div>
                <div class="modal-body">
                    <p>Are you sure you want to save these changes? These changes will take place immediately.</p>
                </div>
                <div class="modal-footer"><button class="btn btn-danger" type="button" data-dismiss="modal">Don't Save</button><button class="btn btn-success" type="button" onclick="submitOutput()">Save</button></div>
            </div>
        </div>
        </div>><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.min.js"></script>
<script src="assets/js/bs-init.js"></script>
<script src="assets/js/jspdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.js"></script>

<script src="./manup.js"></script>
<script src="assets/js/theme.js"></script>
<script src="./assets/js/malware_engine.js"></script>
<script>
  let numberOfQuestions = 1;
let formCreated = {totalQuestions:numberOfQuestions,question1:{
  question:"",answer1:"",answer1Weight:0,answer2:"",answer2Weight:1
}};
let myJSON = JSON.stringify(formCreated, undefined, 4);
document.querySelector("#output").value=myJSON;

let addQuestion=()=>{
    numberOfQuestions++;
    formCreated.totalQuestions=numberOfQuestions;
    let additionalquestion = {
  question:"",answer1:"",answer1Weight:0,answer2:"",answer2Weight:1
};
    $("#questions-here").append('<div id="question-'+numberOfQuestions+'">'+
    '<button class="btn btn-primary float-right btn-sm" type="button"'+ 'style="margin: 10px 0;" onclick="addQuestion()"><i class="fa fa-plus"></i>'+ '</button><label style="margin: 10px 0;"><b>Question '+numberOfQuestions+'</b></label><input type="text"'+ 'class="form-control" id="q'+numberOfQuestions+'" onfocusout="changeJson(this.id,this.value)"/>'+
        '<div class="form-row">'+
            '<div class="col"><label>Answer 1</label><input onfocusout="changeJson(this.id,this.value)" type="text" id="q'+numberOfQuestions+'-a1"'+ 'class="form-control" /></div>'+
            '<div class="col"><label>Weight</label><select onfocusout="changeJson(this.id,this.value)" class="form-control" id="q'+numberOfQuestions+'-w1">'+
    '<option value="0" selected>0</option><option value="1">1</option></select>'+
    '</div></div><div class="form-row">'+
            '<div class="col"><label>Answer 2</label><input onfocusout="changeJson(this.id,this.value)" id="q'+numberOfQuestions+'-a2" type="text"'+ 'class="form-control" /></div>'+
            '<div class="col"><label>Weight</label><select onfocusout="changeJson(this.id,this.value)" id="q'+numberOfQuestions+'-w2" class="form-control">'+
    '<option value="0">0</option><option value="1" selected>1</option></select>'+
    '</div></div></div>');
formCreated["question"+numberOfQuestions]=additionalquestion;
    myJSON = JSON.stringify(formCreated, undefined, 4);
  document.querySelector("#output").value=myJSON;
    
}
let changeJson =(id,value)=>{
    if(id.indexOf("-")>-1){
        let ques = id.split('-')[0].substring(1);
        let answerspec =id.split('-')[1].charAt(0);
        let answer=id.split('-')[1].substring(1);
        switch(answerspec){
            case "a":
                formCreated["question"+ques]["answer"+answer] =value;
                break
            case "w":
                formCreated["question"+ques]["answer"+answer+"Weight"] =value;
                break;
        }
        myJSON = JSON.stringify(formCreated, undefined, 4);
  document.querySelector("#output").value=myJSON;
       
    }
    else{
        let ques = id.substring(1);
        formCreated["question"+ques].question =value;
        myJSON = JSON.stringify(formCreated, undefined, 4);
  document.querySelector("#output").value=myJSON;
    }
}
let checkIfEmpty =()=>{
    let error = 0;
    $("input").each( function() {
        if( $.trim($(this).val()).length == 0 ){
         $(this).css("border","2px solid red");
            error =1;
        }
        else{
            $(this).css("border","1px solid #CED4DA");
        }
    }
    );
    if(error==0){
        $("#confirm-changes").modal({backdrop: "static"});
    }
}
let submitOutput =()=>{
    let outp = JSON.stringify(formCreated);
     if (window.XMLHttpRequest) {
            // code for IE7+, Firefox, Chrome, Opera, Safari
            xmlhttp = new XMLHttpRequest();
        } else {
            // code for IE6, IE5
            xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
        }
    xmlhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
               document.getElementById("message").innerHTML = this.responseText;
               window.scrollTo(0,0);
                $("#confirm-changes").modal("hide");
            }
        };
        xmlhttp.open("POST","./addquestions.php",true);
        xmlhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
        xmlhttp.send("jsonGot="+encodeURI(outp));
}
let fillData =()=>{
formCreated = <?php echo $json_values; ?>;
if(formCreated ==="Could not fill data"){
    document.querySelector("#question-1").innerHTML="Could not fill data. Refresh to use new dataset";
}
else{
    document.querySelector('#removeFill').innerHTML="";
    let weight_1_0 ="",weight_1_1 ="",weight_2_1 ="",weight_2_0 ="";
    numberOfQuestions = formCreated.totalQuestions;
for(let i =1; i<=formCreated.totalQuestions;i++){
    weight_1_0 ="",weight_1_1 ="",weight_2_1 ="",weight_2_0 ="";
    if(formCreated["question"+i].answer1Weight==0){
        weight_1_0 = "selected";
    }
    else{
        weight_1_1 ="selected";
    }
    if(formCreated["question"+i].answer2Weight==0){
        weight_2_0 = "selected";
    }
    else{
        weight_2_1 ="selected";
    }
    $("#removeFill").append('<div id="question-'+i+'">'+
    '<button class="btn btn-primary float-right btn-sm" type="button"'+ 'style="margin: 10px 0;" onclick="addQuestion()"><i class="fa fa-plus"></i>'+ '</button><label style="margin: 10px 0;"><b>Question '+i+'</b></label><input type="text"'+ 'class="form-control" id="q'+i+'" value="'+formCreated["question"+i].question+'" onfocusout="changeJson(this.id,this.value)"/>'+
        '<div class="form-row">'+
            '<div class="col"><label>Answer 1</label><input onfocusout="changeJson(this.id,this.value)" value="'+formCreated["question"+i].answer1+'" type="text" id="q'+i+'-a1"'+ 'class="form-control" /></div>'+
            '<div class="col"><label>Weight</label><select onfocusout="changeJson(this.id,this.value)" class="form-control" id="q'+i+'-w1">'+
    '<option value="0" '+weight_1_0+'>0</option><option value="1" '+weight_1_1+'>1</option></select>'+
    '</div></div><div class="form-row">'+
            '<div class="col"><label>Answer 2</label><input value="'+formCreated["question"+i].answer2+'" onfocusout="changeJson(this.id,this.value)" id="q'+
            i+'-a2" type="text"'+ 'class="form-control" /></div>'+
            '<div class="col"><label>Weight</label><select onfocusout="changeJson(this.id,this.value)" id="q'+i+'-w2" class="form-control">'+
    '<option value="0" '+weight_2_0+'>0</option><option value="1" '+weight_2_1+'>1</option></select>'+
    '</div></div></div>');

}
myJSON = JSON.stringify(formCreated, undefined, 4);
  document.querySelector("#output").value=myJSON;
}
}
let changeOutput =(outputGot)=>{
    try{
formCreated =JSON.parse(outputGot);
document.querySelector('#removeFill').innerHTML="";
    let weight_1_0 ="",weight_1_1 ="",weight_2_1 ="",weight_2_0 ="";
    numberOfQuestions = formCreated.totalQuestions;
for(let i =1; i<=formCreated.totalQuestions;i++){
    weight_1_0 ="",weight_1_1 ="",weight_2_1 ="",weight_2_0 ="";
    if(formCreated["question"+i].answer1Weight==0){
        weight_1_0 = "selected";
    }
    else{
        weight_1_1 ="selected";
    }
    if(formCreated["question"+i].answer2Weight==0){
        weight_2_0 = "selected";
    }
    else{
        weight_2_1 ="selected";
    }
    $("#removeFill").append('<div id="question-'+i+'">'+
    '<button class="btn btn-primary float-right btn-sm" type="button"'+ 'style="margin: 10px 0;" onclick="addQuestion()"><i class="fa fa-plus"></i>'+ '</button><label style="margin: 10px 0;"><b>Question '+i+'</b></label><input type="text"'+ 'class="form-control" id="q'+i+'" value="'+formCreated["question"+i].question+'" onfocusout="changeJson(this.id,this.value)"/>'+
        '<div class="form-row">'+
            '<div class="col"><label>Answer 1</label><input onfocusout="changeJson(this.id,this.value)" value="'+formCreated["question"+i].answer1+'" type="text" id="q'+i+'-a1"'+ 'class="form-control" /></div>'+
            '<div class="col"><label>Weight</label><select onfocusout="changeJson(this.id,this.value)" class="form-control" id="q'+i+'-w1">'+
    '<option value="0" '+weight_1_0+'>0</option><option value="1" '+weight_1_1+'>1</option></select>'+
    '</div></div><div class="form-row">'+
            '<div class="col"><label>Answer 2</label><input value="'+formCreated["question"+i].answer2+'" onfocusout="changeJson(this.id,this.value)" id="q'+
            i+'-a2" type="text"'+ 'class="form-control" /></div>'+
            '<div class="col"><label>Weight</label><select onfocusout="changeJson(this.id,this.value)" id="q'+i+'-w2" class="form-control">'+
    '<option value="0" '+weight_2_0+'>0</option><option value="1" '+weight_2_1+'>1</option></select>'+
    '</div></div></div>');

}

myJSON = JSON.stringify(formCreated, undefined, 4);
  document.querySelector("#output").value=myJSON;
    }
catch(e){
    $("#output").css("border","2px solid red");
    document.querySelector("#jsonerror").innerHTML="&nbsp;"+e;
}
}
</script>
</body>